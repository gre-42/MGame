[
  {
    "declare_macro": "generic_avatar.create",
    "content": [
      {"call": "child_node_instance", "arguments": {"type": "dynamic", "parent": "human_node$suffix", "name": "animation_node$suffix", "position": [0, -0.5, 0], "rotation": [0, 180, 0]}},
      {"comment": "The human hitbox has width and length of 0.5 (or \"radius\" or 0.25), so z = -0.3 is out of its hitbox"},
      {"call": "child_node_instance", "arguments": {"type": "dynamic", "parent": "human_node$suffix", "name": "main_gun_node$suffix", "position": [0.1, 0.5, 0]}},
      {"comment": {"required": "%if_with_graphics", "call": "child_node_instance", "arguments": {"type": "dynamic", "parent": "main_gun_node$suffix", "name": "main_gun_node_visual$suffix", "position": [0, 0, -0.2]}}},
      {"comment": "-0.5 is inside the opponent's hitbox ending at -0.25 - 0.5"},
      {"call": "child_node_instance", "arguments": {"type": "dynamic", "parent": "main_gun_node$suffix",             "name": "main_gun_punch_angle_node$suffix", "position": [0, 0  , -0.5]}},
      {"call": "child_node_instance", "arguments": {"type": "dynamic", "parent": "main_gun_punch_angle_node$suffix", "name": "main_gun_end_node$suffix",         "position": [0, 0  ,    0]}},
      {"call": "child_node_instance", "arguments": {"type": "dynamic", "parent": "animation_node$suffix",            "name": "human_head_node$suffix",           "position": [0, 1.7,    0]}},
      {"call": "child_node_instance", "arguments": {"type": "dynamic", "parent": "human_head_node$suffix",           "name": "human_head_node2$suffix",          "rotation": [0, 180,    0]}},
      {"call": "child_node_instance", "arguments": {"type": "dynamic", "parent": "human_head_node2$suffix",          "name": "human_head_camera_node$suffix"}},
      {
        "required": "%if_with_graphics",
        "call": "child_node_instance",
        "arguments": {
          "type": "dynamic",
          "parent": "animation_node$suffix",
          "name": "main_gun_node_visual0$suffix"
        }
      },
      {
        "comment": {
          "call": "invert",
          "arguments": {
            "rotation": [-90, 90, 0],
            "position": [0.6, -0.1, 0]
          }
        }
      },
      {
        "required": "%if_with_graphics",
        "call": "child_node_instance",
        "arguments": {
          "type": "dynamic",
          "parent": "main_gun_node_visual0$suffix",
          "name": "main_gun_node_visual$suffix",
          "rotation": [90, 0, 90],
          "position": [-0.075, 0, 0.025]
        }
      },
      {
        "call": "rigid_cuboid",
        "arguments": {
          "node": "human_node$suffix",
          "hitboxes": "human_hitboxes",
          "with_penetration_limits": true,
          "mass": 70,
          "size": ["inf", "inf", "inf"],
          "collidable_mode": "collide|move",
          "flags": "is_activated_avatar",
          "waypoint_dy": 0.7,
          "name": "human$suffix",
          "asset_id": "%asset_id"
        }
      },
      {
        "call": "aim_at",
        "arguments": {
          "gun_node": "main_gun_end_node$suffix",
          "parent_follower_rigid_body_node": "human_node$suffix",
          "bullet_start_offset": 0,
          "bullet_velocity": "nan",
          "bullet_feels_gravity": true,
          "gravity": 9.8,
          "locked_on_angle": 20,
          "velocity_error_std": "%velocity_error_std",
          "error_alpha": "%error_alpha"
        }
      },
      {
        "call": "yaw_pitch_look_at_nodes",
        "arguments": {
          "yaw_node": "human_node$suffix",
          "pitch_node": "main_gun_node$suffix",
          "gun_node": "main_gun_end_node$suffix",
          "head_node": "human_head_camera_node$suffix",
          "dyaw_max": 10,
          "pitch_min": -60,
          "pitch_max": 60,
          "dpitch_max": 10,
          "yaw_error_std": "%yaw_error_std",
          "pitch_error_std": "%pitch_error_std",
          "error_alpha": "%error_alpha"
        }
      },
      {
        "required": "%if_with_gun",
        "call": "create_weapon_cycle",
        "arguments": {
          "cycle_node": "human_node$suffix"
        }
      },
      {"required": "%if_with_gun", "call": "set_inventory_capacity", "arguments": {"inventory_node": "human_node$suffix", "item_type": "m4a1_ammo", "capacity": 200}},
      {"required": "%if_with_gun", "call": "set_inventory_capacity", "arguments": {"inventory_node": "human_node$suffix", "item_type": "beretta92_ammo", "capacity": 200}},
      {"required": "%if_with_gun", "call": "set_inventory_capacity", "arguments": {"inventory_node": "human_node$suffix", "item_type": "frag_grenade", "capacity": 10}},
      {"required": "%if_with_gun", "call": "set_inventory_capacity", "arguments": {"inventory_node": "human_node$suffix", "item_type": "m72_law_rocket", "capacity": 2}},
      {"required": "%if_with_gun", "call": "set_inventory_capacity", "arguments": {"inventory_node": "human_node$suffix", "item_type": "none_weapon_ammo_type", "capacity": 0}},
      {
        "required": "%if_with_gun",
        "call": "add_weapon_to_cycle",
        "without": ["full_user_name", "player_name"],
        "arguments": {
          "cycle_node": "human_node$suffix",
          "entry_name": "m4a1",
          "ammo_type": "m4a1_ammo",
          "bullet_type": "m4a1_bullet",
          "cool_down": 0.1,
          "range_min": 0,
          "range_max": 2000,
          "create_weapon": {
            "playback": "add_weapon_m4a1"
          }
        }
      },
      {
        "required": "%if_with_gun",
        "call": "add_weapon_to_cycle",
        "without": ["full_user_name", "player_name"],
        "arguments": {
          "cycle_node": "human_node$suffix",
          "entry_name": "beretta92",
          "ammo_type": "beretta92_ammo",
          "bullet_type": "beretta92_bullet",
          "cool_down": 0.5,
          "range_min": 0,
          "range_max": 2000,
          "create_weapon": {
            "playback": "add_weapon_beretta92"
          }
        }
      },
      {
        "required": "%if_with_gun",
        "call": "add_weapon_to_cycle",
        "without": ["full_user_name", "player_name"],
        "arguments": {
          "cycle_node": "human_node$suffix",
          "entry_name": "frag_grenade",
          "ammo_type": "frag_grenade",
          "bullet_type": "frag_grenade",
          "cool_down": 0.5,
          "range_min": 8,
          "range_max": 20,
          "create_weapon": {
            "playback": "add_weapon_frag_grenade"
          }
        }
      },
      {
        "required": "%if_with_gun",
        "call": "add_weapon_to_cycle",
        "without": ["full_user_name", "player_name"],
        "arguments": {
          "cycle_node": "human_node$suffix",
          "entry_name": "m72_law",
          "ammo_type": "m72_law_rocket",
          "bullet_type": "m72_law_rocket",
          "cool_down": 0.5,
          "range_min": 8,
          "range_max": 2000,
          "create_weapon": {
            "playback": "add_weapon_m72_law"
          }
        }
      },
      {
        "required": "%if_with_gun",
        "call": "set_desired_weapon",
        "arguments": {
          "player": null,
          "cycle_node": "human_node$suffix",
          "weapon": "m4a1",
          "equip_instantly": true
        }
      },
      {
        "exclude": "%if_with_gun",
        "playback": "create_none_weapon",
        "let": {
          "parent_rigid_body_node": "human_node$suffix",
          "ammo_type": "none_weapon_ammo_type",
          "bullet_type": "none_weapon_bullet_type"
        }
      },
      {"required": "%if_with_physics", "call": "set_jump_dv", "arguments": {"node": "human_node$suffix", "value": 17}},
      {
        "required": "%if_with_physics",
        "call": "create_engine",
        "arguments": {
          "rigid_body": "human_node$suffix",
          "name": "legs",
          "angular_vels": [-4000, -2500, 0],
          "powers": ["nan", 2.7, 2.7],
          "gear_ratios": [-1, 1],
          "w_clutch": 800
        }
      },
      {
        "required": "%if_with_physics",
        "call": "wheel",
        "arguments": {
          "vehicle": "human_node$suffix",
          "vehicle_mount_0": [0, 0, 0],
          "vehicle_mount_1": [0, 1, 0],
          "radius": 1,
          "engine": "legs",
          "brake_force": 5000,
          "brake_torque": 400,
          "Ks": 1e5, "Ka": 3e3, "Ke": 1.7, "musF": [0], "musC": [5],
          "tire_id": 0
        }
      },
      {"required": "%if_with_physics", "call": "create_avatar_as_car_controller", "arguments": {"node": "human_node$suffix", "steering_multiplier": 1}},
      {"required": "%if_with_physics", "call": "create_avatar_as_avatar_controller", "arguments": {"node": "human_node$suffix"}},
      {
        "call": "set_avatar_style_updater",
        "arguments": {
          "avatar_node": "human_node$suffix",
          "gun_node": "main_gun_end_node$suffix",
          "resource_wo_gun": "cmu_mocap",
          "resource_w_gun": "xonotic_pyria"
        }
      },
      {
        "call": "set_node_bone",
        "arguments": {
          "node": "human_head_node$suffix",
          "bone": "head",
          "smoothness": 0.9,
          "rotation_strength": 0.2
        }
      },
      {
        "call": "set_node_bone",
        "arguments": {
          "node": "main_gun_node_visual0$suffix",
          "bone": "hand_r",
          "smoothness": 0,
          "rotation_strength": 1
        }
      },
      {"comment": "if_with_graphics renderable_instance name=human_hitbox node=human_node$suffix resource=human_hitbox"},
      {"required": "%if_with_graphics", "call": "child_renderable_instance", "arguments": {"name": "human-inst", "node": "animation_node$suffix", "resource": "$asset_id$decimate"}},
      {"required": "%if_with_graphics", "call": "child_renderable_instance", "arguments": {"name": "human-inst-$decimate1", "node": "animation_node$suffix", "resource": "$asset_id-$decimate1"}},
      {
        "call": "set_available_seats",
        "arguments": {
          "node": "human_node$suffix",
          "value": ["driver"]
        }
      }
    ]
  },
  {
    "declare_macro": "generic_avatar.create_player_externals",
    "content": {
      "required": "%if_pc",
      "playback": "create_avatar_cameras_pc"
    }
  },
  {
    "declare_macro": "generic_avatar.create_player_internals",
    "content": {
      "required": "(%behavior != 'none')",
      "execute": [
        {
          "call": "create_drive_or_walk_ai",
          "arguments": {
            "player": "%player_name",
            "waypoint_reached_radius":                 "%%driving_modes/avatar_$behavior/waypoint_reached_radius",
            "rest_radius":                             "%%driving_modes/avatar_$behavior/rest_radius",
            "lookahead_velocity":                      "%%driving_modes/avatar_$behavior/lookahead_velocity",
            "takeoff_velocity":                        "%%driving_modes/avatar_$behavior/takeoff_velocity",
            "takeoff_velocity_delta":                  "%%driving_modes/avatar_$behavior/takeoff_velocity_delta",
            "max_velocity":                            "%%driving_modes/avatar_$behavior/max_velocity",
            "max_delta_velocity_brake":                "%%driving_modes/avatar_$behavior/max_delta_velocity_brake",
            "collision_avoidance_radius_brake":        "%%driving_modes/avatar_$behavior/collision_avoidance_radius_brake",
            "collision_avoidance_radius_wait":         "%%driving_modes/avatar_$behavior/collision_avoidance_radius_wait",
            "collision_avoidance_radius_correct":      "%%driving_modes/avatar_$behavior/collision_avoidance_radius_correct",
            "collision_avoidance_intersect_angle":     "%%driving_modes/avatar_$behavior/collision_avoidance_intersect_angle",
            "collision_avoidance_step_aside_angle":    "%%driving_modes/avatar_$behavior/collision_avoidance_step_aside_angle",
            "collision_avoidance_step_aside_distance": "%%driving_modes/avatar_$behavior/collision_avoidance_step_aside_distance"
          }
        },
        {
          "call": "set_behavior",
          "arguments": {
            "player": "%player_name",
            "stuck_velocity": "%%driving_modes/avatar_$behavior/stuck_velocity",
            "stuck_duration": "%%driving_modes/avatar_$behavior/stuck_duration",
            "unstuck_duration": "%%driving_modes/avatar_$behavior/unstuck_duration",
            "player_way_points_filter": "%%driving_modes/avatar_$behavior/player_way_points_filter",
            "vehicle_way_points_filter": "explicit_ground|sidewalk"
          }
        },
        {
          "required": "%if_pc",
          "playback": "create_avatar_key_bindings",
          "context": "primary_scene_$full_user_name"
        },
        {
          "required": "%if_pc",
          "call": "hud_target_point",
          "context": "primary_scene_$full_user_name",
          "arguments": {
            "player": "%player_name",
            "gun_node": "main_gun_end_node$suffix",
            "exclusive_nodes": null,
            "ypln_node": "human_node$suffix",
            "center": [0, 0],
            "size": [0.05, 0.05],
            "error_behavior": "center",
            "filename": "textures/hud/crosshair.png"}
        },
        {
          "required": ["%if_pc", "%if_damageable"],
          "call": "ui_background",
          "context": "primary_scene_$full_user_name",
          "arguments": {
            "z_order": 0,
            "player": "%player_name",
            "texture": "#health",
            "left": "health_icon_left",
            "right": "health_icon_right",
            "bottom": "health_icon_bottom",
            "top": "health_icon_top",
            "delay_load_policy": "no_delay",
            "focus_mask": "always"
          }
        },
        {
          "required": ["%if_pc", "%if_damageable"],
          "call": "visual_player_status",
          "context": "primary_scene_$full_user_name",
          "arguments": {
            "player": "%player_name",
            "format": "health",
            "charset": "%selected_language",
            "ttf_file": "fonts/RobotoMono-Bold.ttf",
            "left": "health_text_left",
            "right": "health_text_right",
            "bottom": "health_text_bottom",
            "top": "health_text_top",
            "font_color": "%ui_font_color",
            "font_height": "large",
            "line_distance": "large",
            "focus_mask": "always"
          }
        },
        {
          "required": ["%if_pc", "%if_weapon_cycle"],
          "call": "ui_background",
          "context": "primary_scene_$full_user_name",
          "arguments": {
            "z_order": 0,
            "player": "%player_name",
            "texture": "#ammunition",
            "left": "bullet_count_icon_left",
            "right": "bullet_count_icon_right",
            "bottom": "bullet_count_icon_bottom",
            "top": "bullet_count_icon_top",
            "delay_load_policy": "no_delay",
            "focus_mask": "always"
          }
        },
        {
          "required": ["%if_pc", "%if_weapon_cycle"],
          "call": "visual_player_bullet_count",
          "context": "primary_scene_$full_user_name",
          "arguments": {
            "z_order": 0,
            "player": "%player_name",
            "left": "bullet_count_text_left",
            "right": "bullet_count_text_right",
            "bottom": "bullet_count_text_bottom",
            "top": "bullet_count_text_top",
            "charset": "%selected_language",
            "ttf_file": "fonts/RobotoMono-Bold.ttf",
            "font_color": [1, 1, 1],
            "font_height": "large",
            "line_distance": "large",
            "focus_mask": "always"
          }
        },
        {
          "required": "%if_with_gun",
          "call": "player_set_aiming_gun",
          "arguments": {
            "player": "%player_name",
            "gun_node": "main_gun_end_node$suffix"
          }
        },
        {
          "call": "player_set_vehicle_control_parameters",
          "arguments": {
            "surface_power_forward": "inf",
            "surface_power_backward": "-inf",
            "player": "%player_name",
            "max_tire_angle": "%%vehicles/$asset_id/max_tire_angle"
          }
        }
      ]
    }
  }
]
