[
  {
    "declare_macro": "_scene_racing_instantiate_static_objects",
    "content": [
      {
        "comment": "OSM instance"
      },
      {
        "comment": "Must be above instantiation, and should be above transformations"
      },
      {
        "required": ["IF_EXTRACT_ALIGNMENT_PLANES"],
        "call": "modify_physics_material_tags",
        "literals": {
          "resource_name": "osm_map",
          "add": "obj_alignment_plane",
          "remove": "attr_visible",
          "included_names": "\\balignment_plane(?:\\b|_)"
        }
      },
      {
        "call": "modify_physics_material_tags",
        "literals": {
          "resource_name": "osm_map",
          "remove": "attr_visible",
          "included_names": "\\bHitbox(?:\\b|_)"
        }
      },
      {
        "call": "modify_physics_material_tags",
        "literals": {
          "resource_name": "osm_map",
          "remove": "attr_collide",
          "included_names": "\\bVisual(?:\\b|_)"
        }
      },
      {
        "call": "modify_physics_material_tags",
        "literals": {
          "resource_name": "osm_map",
          "add": "attr_align_strict",
          "included_names": "\\bAlignStrict(?:\\b|_)"
        }
      },
      {
        "required": ["IF_GEN_GRIND_LINES"],
        "call": "gen_grind_lines",
        "literals": {
          "source_name": "osm_map",
          "dest_name": "osm_map_grind_lines",
          "edge_angle": 20,
          "averaged_normal_angle": 6,
          "excluded_names": "\\bNoGrind(?:\\b|_)",
          "included_tags": "attr_collide",
          "excluded_tags": "obj_alignment_plane"
        }
      },
      {
        "exclude": ["IF_GEN_GRIND_LINES"],
        "call": "obj_resource",
        "literals": {
          "name": "osm_map_grind_lines",
          "filename": "models/primitives/empty.obj",
          "position": [0, 0, 0],
          "rotation": [0, 0, 0],
          "scale": [1, 1, 1],
          "center_distances": [0, 501],
          "blend_mode": "off",
          "alpha_distances": [0, 0, "inf", "inf"],
          "occluded_pass": "none",
          "occluder_pass": "none",
          "aggregate_mode": "none",
          "transformation_mode": "all"
        }
      },
      {
        "exclude": ["IF_GEN_GRIND_LINES"],
        "call": "modify_physics_material_tags",
        "literals": {
          "resource_name": "osm_map_grind_lines",
          "add": "obj_grind_line"
        }
      },
      {
        "required": ["IF_GEN_INSTANCES"],
        "call": "gen_instances",
        "literals": {
          "name": "osm_map"
        }
      },
      {
        "comment": "Must be below extractions"
      },
      {
        "call": "root_node_instance",
        "literals": {
          "type": "static",
          "name": "osm_map_node",
          "position": "%OSM_POSITION",
          "rotation": "%OSM_ROTATION",
          "scale": "%OSM_SCALE"
        }
      },
      {
        "call": "renderable_instance",
        "literals": {
          "name": "osm-inst",
          "node": "osm_map_node",
          "resource": "osm_map"
        }
      },
      {
        "call": "rigid_cuboid",
        "literals": {
          "node": "osm_map_node",
          "hitboxes": ["osm_map", "osm_map_grind_lines"],
          "mass": "inf",
          "size": [1, 2, 3],
          "collidable_mode": "terrain",
          "name": "osm_map"
        }
      },
      {
        "comment": "collidable-mesh rigid_body-node=osm_map_node node=osm_map_node resource=osm_map"
      },
      {
        "required": ["IF_WITH_GEOGRAPHIC_MAPPING"],
        "call": "register_geographic_mapping",
        "literals": {
          "name": "world",
          "node": "osm_map_node",
          "resource": "osm_map"
        }
      },
      {
        "comment": "Player"
      },
      {
        "required": ["IF_CREATE_PC_PLAYER"],
        "call": "player_create",
        "literals": {
          "name": "you",
          "team": "red",
          "game_mode": "racing",
          "unstuck_mode": "off",
          "driving_mode": "car_rally",
          "driving_direction": "center"
        }
      },
      {
        "required": ["IF_CREATE_PC_PLAYER"],
        "call": "set_can_drive",
        "literals": { "player": "you", "source": "user", "value": true }
      },
      {
        "required": ["IF_CREATE_PC_PLAYER"],
        "call": "set_can_aim",
        "literals": { "player": "you", "source": "user", "value": true }
      },
      {
        "required": ["IF_CREATE_PC_PLAYER"],
        "call": "set_can_shoot",
        "literals": { "player": "you", "source": "user", "value": true }
      },
      {
        "required": ["IF_PC_PLAYER_PLAYBACK"],
        "call": "set_playback_way_points",
        "literals": { "player": "you", "filename": "%PC_PLAYER_PLAYBACK", "speedup": "%PC_PLAYER_PLAYBACK_SPEEDUP" }
      },
      {
        "required": ["IF_PC_PLAYER_PLAYBACK"],
        "call": "set_can_drive",
        "literals": { "player": "you", "source": "ai", "value": true }
      },
      {
        "call": "ui_background",
        "literals": {
          "z_order": 1,
          "texture": "textures/ui_background.png",
          "left": "highscore_left",
          "right": "highscore_right",
          "bottom": "highscore_bottom",
          "top": "highscore_top",
          "update": "once",
          "focus_mask": "always"
        }
      },
      {
        "call": "players_stats",
        "literals": {
          "z_order": 1,
          "ttf_file": "fonts/RobotoMono-Bold.ttf",
          "left": "highscore_left",
          "right": "highscore_right",
          "bottom": "highscore_bottom",
          "top": "highscore_top",
          "font_height": "normal",
          "line_distance": "normal",
          "score_board": "%SCORE_BOARD"
        }
      },
      {
        "comment": "Global log"
      },
      {
        "call": "visual_global_log",
        "literals": {
          "ttf_file": "fonts/RobotoMono-Bold.ttf",
          "left": "highscore_left",
          "right": "highscore_right",
          "bottom": "highscore_bottom",
          "top": "highscore_top",
          "font_height": "normal",
          "line_distance": "normal",
          "nentries": 10,
          "severity": "critical"
        }
      },
      {
        "comment": "Countdown"
      },
      {
        "call": "ui_background",
        "literals": {
          "z_order": 1,
          "texture": "textures/ui_background.png",
          "left": "min",
          "right": "max",
          "bottom": "min",
          "top": "max",
          "update": "once",
          "focus_mask": "countdown_any|game_over_countdown_any"
        }
      },
      {
        "call": "countdown",
        "literals": {
          "node": "countdown",
          "z_order": 1,
          "ttf_file": "fonts/RobotoMono-Bold.ttf",
          "position": ["nan", "nan"],
          "font_height": "huge",
          "line_distance": "huge",
          "nseconds": 5,
          "pending_focus": "countdown_pending",
          "counting_focus": "countdown_counting",
          "text": ""
        }
      },
      {
        "call": "countdown",
        "literals": {
          "node": "game_over_countdown",
          "z_order": 1,
          "ttf_file": "fonts/RobotoMono-Bold.ttf",
          "position": ["nan", "nan"],
          "font_height": "huge",
          "line_distance": "huge",
          "nseconds": 3,
          "pending_focus": "game_over_countdown_pending",
          "counting_focus": "game_over_countdown_counting",
          "text": "Game over"
        }
      },
      {
        "comment": "Dirtmap"
      },
      {
        "required": ["IF_DIRTMAP"],
        "call": "root_node_instance",
        "literals": {
          "type": "dynamic",
          "name": "dirtmap_node",
          "position": [0, 1000, 0],
          "rotation": [-90, 0, 0],
          "scale": 1
        }
      },
      {
        "required": ["IF_DIRTMAP"],
        "call": "ortho_camera",
        "literals": {
          "node": "dirtmap_node",
          "near_plane": 1,
          "far_plane": 10000,
          "left_plane": "%DIRTMAP_LEFT",
          "right_plane": "%DIRTMAP_RIGHT",
          "bottom_plane": "%DIRTMAP_BOTTOM",
          "top_plane": "%DIRTMAP_TOP",
          "requires_postprocessing": false
        }
      },
      {
        "required": ["IF_DIRTMAP"],
        "call": "set_dirtmap",
        "literals": {
          "filename": "%DIRTMAP_TEXTURE",
          "offset": "%DIRTMAP_OFFSET",
          "discreteness": "%DIRTMAP_DISCRETENESS",
          "scale": "%DIRT_SCALE",
          "wrap_mode": "%DIRTMAP_WRAP_MODE"
        }
      },
      {
        "comment": "Soft light"
      },
      {
        "call": "set_soft_light",
        "literals": {
          "filename": "%SOFT_LIGHT_TEXTURE"
        }
      },
      {
        "comment": "Skybox"
      },
      {
        "call": "set_skybox",
        "literals": {
          "alias": "%SKYBOX"
        }
      },
      {
        "required": ["IF_DAY"],
        "call": "set_background_color",
        "literals": { "color": [0.68, 0.85, 1] }
      },
      {
        "required": ["IF_NIGHT"],
        "call": "set_background_color",
        "literals": { "color": [0, 0, 0] }
      },
      {
        "required": ["IF_SYNTHWAVE"],
        "call": "set_background_color",
        "literals": { "color": [0.65, 0.36, 0.91] }
      },
      {
        "comment": "include playback_resource.scn"
      },
      {
        "comment": "Light"
      },
      {
        "required": ["IF_DAY"],
        "playback": "add_distant_light_day",
        "literals": { "LEFT": "%SUN_LEFT", "RIGHT": "%SUN_RIGHT", "BOTTOM": "%SUN_BOTTOM", "TOP": "%SUN_TOP" }
      },
      {
        "required": ["IF_NIGHT"],
        "playback": "add_distant_light_night",
        "literals": { "LEFT": "%SUN_LEFT", "RIGHT": "%SUN_RIGHT", "BOTTOM": "%SUN_BOTTOM", "TOP": "%SUN_TOP" }
      },
      {
        "required": ["IF_SYNTHWAVE"],
        "playback": "add_distant_light_night",
        "literals": { "LEFT": "%SUN_LEFT", "RIGHT": "%SUN_RIGHT", "BOTTOM": "%SUN_BOTTOM", "TOP": "%SUN_TOP"
        }
      },
      {
        "required": ["IF_DAY"],
        "playback": "add_local_instances_light",
        "literals": { "LSUFFIX": "_local_instances" }
      },
      {
        "required": ["IF_NIGHT"],
        "playback": "add_local_blob_instances_light",
        "literals": { "LSUFFIX": "_blobs" }
      },
      {
        "required": ["IF_SYNTHWAVE"],
        "playback": "add_local_blob_instances_light",
        "literals": { "LSUFFIX": "_blobs" }
      },
      {
        "comment": "Reflection map"
      },
      {
        "required": ["IF_DAY"],
        "call": "add_color_style",
        "literals": {
          "reflection_strength": 0.5,
          "reflection_maps": {
            "car": "reflection_map",
            "wet_street": "reflection_map",
            "ground": ""
          }
        }
      },
      {
        "required": ["IF_NIGHT"],
        "call": "add_color_style",
        "literals": {
          "reflection_strength": 0.5,
          "reflection_maps": {
            "car": "reflection_map_night",
            "wet_street":  "reflection_map_night",
            "ground": ""}
          }
      },
      {
        "required": ["IF_SYNTHWAVE"],
        "call": "add_color_style",
        "literals": {
          "reflection_strength": 0.5,
          "reflection_maps": {
            "car": "reflection_map_synthwave",
            "ground": "reflection_map_synthwave"
          }
        }
      },
      {
        "comment": "Cameras"
      },
      {
        "call": "root_node_instance",
        "literals": {
          "type": "dynamic",
          "name": "stadium_camera",
          "position": "%STADIUM_CAMERA_POSITION",
          "rotation": [-45, 0, 0],
          "scale": 1
        }
      },
      {
        "call": "perspective_camera",
        "literals": {
          "node": "stadium_camera",
          "y_fov": 30,
          "near_plane": 1,
          "far_plane": 10000,
          "requires_postprocessing": false
        }
      },
      {
        "call": "set_camera_cycle",
        "literals": { "name": "far", "cameras": ["stadium_camera"] }
      },
      {
        "call": "set_camera_cycle",
        "literals": { "name": "near", "cameras": [] }
      },
      {
        "call": "set_camera",
        "literals": { "name": "stadium_camera" }
      },
      {
        "comment": "Key bindings"
      },
      {
        "call": "camera_key_binding",
        "literals": {
          "id": "change_camera"
        }
      },
      {
        "call": "load_key_configurations",
        "literals": {
          "filename": "$__APPDATA__/key_configurations.json",
          "fallback_filename": "$__DIR__/key_configurations.json"
        }
      }
    ]
  },
  {
    "declare_macro": "_create_playback",
    "content": [
      {
        "playback": "create_car",
        "literals": {
          "CAR_NODE_POSITION": [1, 2, 3],
          "CAR_NODE_ANGLES": [4, 5, 6],
          "CAR_NAME": "%PLAYBACK_CAR",
          "DECIMATE": "%DECIMATE",
          "SUFFIX": "_playback_track$PSUFFIX",
          "IF_WITH_GRAPHICS": true,
          "IF_WITH_PHYSICS": false,
          "IF_PLAYBACK_TRACK": true,
          "IF_PLAYBACK_WINNER": false,
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "PLAYBACK_FILENAME": "%PLAYBACK_FILENAME",
          "PSUFFIX": "%PSUFFIX",
          "IF_PLAYER": false,
          "IF_SHADOW": true,
          "IF_DAMAGEABLE": false,
          "IF_CAR_BODY_RENDERABLE_STYLE": false,
          "VELOCITY_ERROR_STD": 0,
          "YAW_ERROR_STD": 0,
          "PITCH_ERROR_STD": 0,
          "ERROR_ALPHA": 1,
          "IF_PC": false
        }
      }
    ]
  },
  {
    "declare_macro": "create_winner_playback",
    "content": [
      {
        "playback": "create_car",
        "literals": {
          "CAR_NODE_POSITION": [1, 2, 3],
          "CAR_NODE_ANGLES": [4, 5, 6],
          "CAR_NAME": "%PLAYBACK_CAR",
          "DECIMATE": "%DECIMATE",
          "SUFFIX": "_playback_winner$PSUFFIX",
          "HAND_BRAKE_PULLED": null,
          "IF_DYNAMIC": null,
          "IF_STATIC": null,
          "IF_RACING": null,
          "IF_RALLY": null,
          "IF_WITH_GRAPHICS": true,
          "IF_WITH_PHYSICS": false,
          "IF_PLAYBACK_TRACK": false,
          "IF_PLAYBACK_WINNER": true,
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "RANK": "%RANK",
          "IF_PLAYER": false,
          "IF_SHADOW": true,
          "IF_DAMAGEABLE": false,
          "IF_CAR_BODY_RENDERABLE_STYLE": true,
          "COLOR": "%COLOR",
          "VELOCITY_ERROR_STD": 0,
          "YAW_ERROR_STD": 0,
          "PITCH_ERROR_STD": 0,
          "ERROR_ALPHA": 1,
          "IF_PC": false
        }
      },
      {
        "comment": "add_node_not_allowed_to_be_unregistered name=light_node_car_playback_winner-PSUFFIX"
      }
    ]
  },
  {
    "declare_macro": "_scene_racing_instantiate_transient_objects",
    "content": [
      {
        "comment": "Car instance"
      },
      {
        "required": ["IF_CREATE_PC_CAR"],
        "playback":  "create_$SELECTED_VEHICLE_CLASS",
        "literals": {
          "HUMAN_NAME": "%SELECTED_VEHICLE_SUFFIX",
          "SKATER_NAME": "%SELECTED_VEHICLE_SUFFIX",
          "CAR_NAME": "%SELECTED_VEHICLE_SUFFIX",
          "HUMAN_NODE_POSITION": "%HUMAN_NODE_POSITION",
          "SKATER_NODE_POSITION": "%SKATER_NODE_POSITION",
          "CAR_NODE_POSITION": "%CAR_NODE_POSITION",
          "HUMAN_NODE_ANGLE_Y": "%HUMAN_NODE_ANGLE_Y",
          "SKATER_NODE_ANGLE_Y": "%SKATER_NODE_ANGLE_Y",
          "CAR_NODE_ANGLES": "%CAR_NODE_ANGLES",
          "IF_HUMAN_STYLE": true,
          "IF_SKATER_STYLE": true,
          "IF_CAR_BODY_RENDERABLE_STYLE": true,
          "COLOR": "%SELECTED_PLAYER_VEHICLE_COLOR",
          "DECIMATE": "",
          "SUFFIX": "",
          "IF_WITH_GRAPHICS": true,
          "IF_WITH_PHYSICS": true,
          "IF_RACING": "%IF_RACING",
          "IF_RALLY": "%IF_RALLY",
          "IF_WITH_GUN": false,
          "IF_STATIC": false,
          "IF_DYNAMIC": true,
          "IF_MANUAL_DRIVE": "%!IF_PC_PLAYER_PLAYBACK",
          "IF_MANUAL_AIM": false,
          "HAND_BRAKE_PULLED": "%HAND_BRAKE_PULLED",
          "VELOCITY_ERROR_STD": 0,
          "YAW_ERROR_STD": 0,
          "PITCH_ERROR_STD": 0,
          "ERROR_ALPHA": 1,
          "IF_SHADOW": true,
          "IF_PLAYBACK_TRACK": false,
          "IF_PLAYBACK_WINNER": false,
          "IF_PLAYER": true,
          "IF_DAMAGEABLE": false,
          "PLAYER_NAME": "you",
          "IF_PC": true
        }
      },
      {
        "required": ["IF_BURN_IN"],
        "call": "burn_in",
        "literals": {
          "seconds": 20
        }
      },
      {
        "comment": "Recording"
      },
      {
        "required": ["IF_RECORD_TRACK"],
        "call": "record_track",
        "literals": { "node": "car_node", "filename": "/tmp/track.m" }
      },
      {
        "required": ["IF_RECORD_TRACK"],
        "call": "record_track_gpx",
        "literals": { "node": "car_node", "filename": "/tmp/track.gpx" }
      },
      {
        "required": ["IF_PLAYBACK_CHECKPOINTS"],
        "playback": "create_playback",
        "literals": {
          "PLAYBACK_FILENAME": "%CHECKPOINTS_FILE",
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "PLAYBACK_CAR": "_M3",
          "DECIMATE": "",
          "PSUFFIX": "checkpoints"
        }
      },
      {
        "required": ["IF_PLAYBACK_TRACK_1"],
        "playback": "create_playback",
        "literals": {
          "PLAYBACK_FILENAME": "$RECORDINGS_DIR/track1.m",
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "PLAYBACK_CAR": "_M3",
          "DECIMATE": "",
          "PSUFFIX": "track1"
        }
      },
      {
        "required": ["IF_PLAYBACK_TRACK_2"],
        "playback": "create_playback",
        "literals": {
          "PLAYBACK_FILENAME": "$RECORDINGS_DIR/track2.m",
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "PLAYBACK_CAR": "_XZ",
          "DECIMATE": "",
          "PSUFFIX": "track2"
        }
      },
      {
        "required": ["IF_PLAYBACK_TRACK_3"],
        "playback": "create_playback",
        "literals": {
          "PLAYBACK_FILENAME": "$RECORDINGS_DIR/track3.m",
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "PLAYBACK_CAR": "_FN",
          "DECIMATE": "",
          "PSUFFIX": "track3"
        }
      },
      {
        "call": "define_winner_conditionals",
        "literals": {
          "begin_rank": 0,
          "end_rank": 3
        }
      },
      {
        "required": ["IF_PLAYBACK_WINNER_0", "IF_WINNER_RANK0_EXISTS"],
        "playback": "create_winner_playback",
        "literals": {
          "RANK": 0,
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "PLAYBACK_CAR":"_$WINNER0_VEHICLE",
          "COLOR": "%WINNER0_COLOR",
          "DECIMATE": "",
          "PSUFFIX": "1"
        }
      },
      {
        "required": ["IF_PLAYBACK_WINNER_1", "IF_WINNER_RANK1_EXISTS"],
        "playback": "create_winner_playback",
        "literals": {
          "RANK": 1,
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "PLAYBACK_CAR":"_$WINNER1_VEHICLE",
          "COLOR": "%WINNER1_COLOR",
          "DECIMATE": "",
          "PSUFFIX": "2"
        }
      },
      {
        "required": ["IF_PLAYBACK_WINNER_2", "IF_WINNER_RANK2_EXISTS"],
        "playback": "create_winner_playback",
        "literals": {
          "RANK": 2,
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "PLAYBACK_CAR":"_$WINNER2_VEHICLE",
          "COLOR": "%WINNER2_COLOR",
          "DECIMATE": "",
          "PSUFFIX": "3"
        }
      },
      {
        "required": ["IF_CHECKPOINTS"],
        "call": "check_points",
        "literals": {
          "moving_node": "car_node",
          "resource": "glow",
          "player": "you",
          "nbeacons": 40,
          "nth": 30,
          "nahead": 30,
          "radius": 30,
          "height_changed": false,
          "track_filename": "%CHECKPOINTS_FILE",
          "laps": "%RACE_LAPS",
          "pacenotes_filename": "%PACENOTES_FILE",
          "pacenotes_meters_ahead": 50,
          "pacenotes_minimum_covered_meters": 200,
          "pacenotes_maximum_number": 3,
          "pacenotes_pictures_left": [
            "pacenote_l0",
            "pacenote_l1",
            "pacenote_l2",
            "pacenote_l3",
            "pacenote_l4",
            "pacenote_l5",
            "pacenote_l6",
            "pacenote_l7"],
          "pacenotes_pictures_right": [
            "pacenote_r0",
            "pacenote_r1",
            "pacenote_r2",
            "pacenote_r3",
            "pacenote_r4",
            "pacenote_r5",
            "pacenote_r6",
            "pacenote_r7"],
          "pacenotes_ttf": "fonts/RobotoMono-Bold.ttf",
          "pacenotes_color": [0, 0, 0],
          "pacenotes_widget_distance": "pacenotes_widget_distance",
          "pacenotes_text_left": "pacenotes_text_left",
          "pacenotes_text_right": "pacenotes_text_right",
          "pacenotes_text_bottom": "pacenotes_text_bottom",
          "pacenotes_text_top": "pacenotes_text_top",
          "pacenotes_picture_left": "pacenotes_picture_left",
          "pacenotes_picture_right": "pacenotes_picture_right",
          "pacenotes_picture_bottom": "pacenotes_picture_bottom",
          "pacenotes_picture_top": "pacenotes_picture_top",
          "pacenotes_font_height": "huge",
          "selection_emissivity": "%CHECK_POINTS_ACTIVE_COLOR",
          "deselection_emissivity": "%CHECK_POINTS_INACTIVE_COLOR",
          "on_finish": {
            "call": "set_focuses",
            "literals": {"focuses": ["menu", "game_over_countdown_pending"]}
          }
        }
      },
      {
        "comment": "Cameras"
      },
      {
        "required": ["IF_CREATE_PC_CAR"],
        "call": "create_externals",
        "literals": {
          "player": "you",
          "mode": "pc"
        }
      }
    ]
  },
  {
    "declare_macro": "__setup_new_round",
    "content": [
      {
        "call": "set_focuses",
        "literals": {"focuses": ["scene", "countdown_pending"]}
      },
      {
        "call": "delete_root_nodes",
        "literals": {
          "regex": "^(car|human|skater)_node_playback_track\\d+$"
        }
      },
      {
        "call": "delete_root_nodes",
        "literals": {
          "regex": "^(car|human|skater)_node_playback_winner\\d+$"
        }
      },
      {
        "call": "delete_root_nodes",
        "literals": {
          "regex": "^(bullet|trail|particles_\\w+|snow|explosion)___\\d+$"
        }
      },
      {
        "call": "delete_scheduled_advance_times"
      },
      {
        "required": ["IF_LOADED_GAME_MODE_RALLY"],
        "call": "set_race_identifier_and_reload_history",
        "literals": {
          "level_id": "%LOADED_LEVEL_ID",
          "session": "%LOADED_RACE_SESSION",
          "laps": "%LOADED_RACE_LAPS",
          "milliseconds": 0
        }
      },
      {
        "required": ["IF_LOADED_GAME_MODE_RALLY"],
        "call": "start_race",
        "literals": {
          "readonly": false
        }
      },
      {
        "call": "respawn_all_players"
      },
      {
        "call": "reset_supply_depot_cooldowns"
      },
      {
        "call": "invalidate_aggregate_renderers"
      }
    ]
  },
  {
    "declare_macro": "_setup_new_round",
    "content": [
      {
        "call": "with_delete_node_mutex",
        "literals": {
          "command": {
            "playback": "__setup_new_round"
          }
        }
      }
    ]
  },
  {
    "declare_macro": "_setup_weapon_closeup",
    "content": [
      {
        "call": "root_node_instance",
        "literals": {
          "type": "dynamic",
          "name": "light_node",
          "position": [-3, 3, 0],
          "rotation": [-45, 0, 0],
          "scale": 1
        }
      },
      {
        "call": "light_without_shadow",
        "literals": {
          "node": "light_node",
          "ambience": [0.5, 0.5, 0.5],
          "diffusivity": [1, 1, 1],
          "specularity": [1, 1, 1]
        }
      },
      {
        "playback": "scene_minimal",
        "literals": {
          "IF_DIRTMAP": false,
          "IF_SKYBOX": false
        }
      },
      {
        "call": "scene_to_percentage_region",
        "literals": {
          "target_scene": "primary_scene",
          "z_order": 1,
          "position": [0.1, 0.5],
          "size": [1, 1],
          "focus_mask": "always",
          "submenus": []
        }
      }
    ]
  },
  {
    "declare_macro": "scene_racing_static",
    "content": [
      {"playback": "create_scene_loading"},
      {"playback": "%OSM_MAP_RESOURCE"},
      {
        "required": ["IF_HAS_OVERLAY"],
        "playback": "%OSM_MAP_OVERLAY_RESOURCE"
      },
      {
        "call": "create_scene",
        "literals": {
          "name": "primary_scene",
          "z_order": 0,
          "focus_mask": "scene|countdown_any|game_over_countdown_any",
          "submenus": [],
          "fly": "%PRIMARY_SCENE_FLY",
          "rotate": "%PRIMARY_SCENE_ROTATE",
          "print_gamepad_buttons": "%PRIMARY_SCENE_PRINT_GAMEPAD_BUTTONS",
          "depth_fog": "%PRIMARY_SCENE_DEPTH_FOG",
          "low_pass": "%PRIMARY_SCENE_LOW_PASS",
          "high_pass": "%PRIMARY_SCENE_HIGH_PASS",
          "with_skybox": "%PRIMARY_SCENE_WITH_SKYBOX",
          "with_flying_logic": "%PRIMARY_SCENE_WITH_FLYING_LOGIC",
          "clear_mode": "%PRIMARY_SCENE_CLEAR_MODE",
          "max_tracks": 5,
          "setup_new_round": {
            "playback": "_setup_new_round",
            "context": "primary_scene"
          }
        }
      },
      {
        "call": "create_scene",
        "literals": {
          "name": "weapon_closeup",
          "z_order": 0,
          "focus_mask": "scene|countdown_any|game_over_countdown_any",
          "submenus": [],
          "fly": false,
          "rotate": false,
          "print_gamepad_buttons": false,
          "depth_fog": false,
          "low_pass": false,
          "high_pass": false,
          "with_skybox": false,
          "with_flying_logic": false,
          "clear_mode": "depth"
        }
      },
      {
        "playback": "_setup_weapon_closeup",
        "context": "weapon_closeup"
      },
      {
        "playback": "_scene_racing_instantiate_static_objects",
        "context": "primary_scene",
        "literals": {
          "IF_CREATE_PC_PLAYER": "%IF_CREATE_PC_PLAYER",
          "IF_PC_PLAYER_PLAYBACK": "%IF_PC_PLAYER_PLAYBACK",
          "PC_PLAYER_PLAYBACK": "%PC_PLAYER_PLAYBACK",
          "PC_PLAYER_PLAYBACK_SPEEDUP": "%PC_PLAYER_PLAYBACK_SPEEDUP",
          "SCORE_BOARD": "%SCORE_BOARD",
          "OSM_POSITION": "%OSM_POSITION",
          "OSM_ROTATION": "%OSM_ROTATION",
          "OSM_SCALE": "%OSM_SCALE",
          "IF_GEN_GRIND_LINES": "%IF_GEN_GRIND_LINES",
          "IF_GEN_INSTANCES": "%IF_GEN_INSTANCES",
          "IF_EXTRACT_ALIGNMENT_PLANES": "%IF_EXTRACT_ALIGNMENT_PLANES",
          "IF_WITH_GEOGRAPHIC_MAPPING": "%IF_WITH_GEOGRAPHIC_MAPPING",
          "SKYBOX": "%SKYBOX",
          "IF_DAY": "%IF_DAY",
          "IF_NIGHT": "%IF_NIGHT",
          "IF_SYNTHWAVE": "%IF_SYNTHWAVE",
          "STADIUM_CAMERA_POSITION": "%STADIUM_CAMERA_POSITION",
          "DIRTMAP_LEFT": "%DIRTMAP_LEFT",
          "DIRTMAP_RIGHT": "%DIRTMAP_RIGHT",
          "DIRTMAP_BOTTOM": "%DIRTMAP_BOTTOM",
          "DIRTMAP_TOP": "%DIRTMAP_TOP",
          "IF_DIRTMAP": "%IF_DIRTMAP",
          "DIRTMAP_TEXTURE": "%DIRTMAP_TEXTURE",
          "DIRTMAP_OFFSET": "%DIRTMAP_OFFSET",
          "DIRTMAP_DISCRETENESS": "%DIRTMAP_DISCRETENESS",
          "DIRT_SCALE": "%DIRT_SCALE",
          "DIRTMAP_WRAP_MODE": "%DIRTMAP_WRAP_MODE",
          "SUN_LEFT": "%SUN_LEFT",
          "SUN_RIGHT": "%SUN_RIGHT",
          "SUN_BOTTOM": "%SUN_BOTTOM",
          "SUN_TOP": "%SUN_TOP",
          "SOFT_LIGHT_TEXTURE": "%SOFT_LIGHT_TEXTURE"
        }
      }
    ]
  },
  {
    "declare_macro": "generic_scene_racing_dynamic",
    "content": [
      {
        "call": "constant_parameter",
        "literals": { "name": "IF_LOADED_GAME_MODE_RALLY", "value": "%IF_GAME_MODE_RALLY" }
      },
      {
        "call": "constant_parameter",
        "literals": { "name": "LOADED_LEVEL_ID", "value": "%LEVEL_ID" }
      },
      {
        "call": "constant_parameter",
        "literals": { "name": "LOADED_RACE_SESSION", "value": "%RACE_SESSION" }
      },
      {
        "call": "constant_parameter",
        "literals": { "name": "LOADED_RACE_LAPS", "value": "%RACE_LAPS" }
      },
      {
        "playback": "_setup_new_round",
        "context": "primary_scene"
      },
      {
        "playback": "_scene_racing_instantiate_transient_objects",
        "context": "primary_scene",
          "literals": {
          "IF_CREATE_PC_CAR": "%IF_CREATE_PC_CAR",
          "IF_PC_PLAYER_PLAYBACK": "%IF_PC_PLAYER_PLAYBACK",
          "HUMAN_NODE_POSITION": "%HUMAN_NODE_POSITION",
          "SKATER_NODE_POSITION": "%SKATER_NODE_POSITION",
          "CAR_NODE_POSITION": "%CAR_NODE_POSITION",
          "HUMAN_NODE_ANGLE_Y": "%HUMAN_NODE_ANGLE_Y",
          "SKATER_NODE_ANGLE_Y": "%SKATER_NODE_ANGLE_Y",
          "CAR_NODE_ANGLES": "%CAR_NODE_ANGLES",
          "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
          "HAND_BRAKE_PULLED": "%HAND_BRAKE_PULLED",
          "IF_RACING": "%IF_RACING",
          "IF_RALLY": "%IF_RALLY",
          "IF_BURN_IN": "%IF_BURN_IN",
          "IF_MANUAL_AIM": "%IF_MANUAL_AIM",
          "VELOCITY_ERROR_STD": "%VELOCITY_ERROR_STD",
          "YAW_ERROR_STD": "%YAW_ERROR_STD",
          "PITCH_ERROR_STD": "%PITCH_ERROR_STD",
          "ERROR_ALPHA": "%ERROR_ALPHA",
          "IF_RECORD_TRACK": "%IF_RECORD_TRACK",
          "RECORDINGS_DIR": "%RECORDINGS_DIR",
          "CHECKPOINTS_FILE": "%CHECKPOINTS_FILE",
          "PACENOTES_FILE": "%PACENOTES_FILE",
          "RACE_LAPS": "%RACE_LAPS",
          "IF_PLAYBACK_CHECKPOINTS": "%IF_PLAYBACK_CHECKPOINTS",
          "IF_PLAYBACK_TRACK_1": "%IF_PLAYBACK_TRACK_1",
          "IF_PLAYBACK_TRACK_2": "%IF_PLAYBACK_TRACK_2",
          "IF_PLAYBACK_TRACK_3": "%IF_PLAYBACK_TRACK_3",
          "IF_PLAYBACK_WINNER_0": "%IF_PLAYBACK_WINNER_0",
          "IF_PLAYBACK_WINNER_1": "%IF_PLAYBACK_WINNER_1",
          "IF_PLAYBACK_WINNER_2": "%IF_PLAYBACK_WINNER_2",
          "IF_CHECKPOINTS": "%IF_CHECKPOINTS",
          "CHECK_POINTS_ACTIVE_COLOR": "%CHECK_POINTS_ACTIVE_COLOR",
          "CHECK_POINTS_INACTIVE_COLOR": "%CHECK_POINTS_INACTIVE_COLOR",
          "TEAMS_SPAWN_POINTS_RESOURCE": "%TEAMS_SPAWN_POINTS_RESOURCE",
          "TEAMS_WAY_POINTS_RESOURCE": "%TEAMS_WAY_POINTS_RESOURCE"
        }
      }
    ]
  }
]
